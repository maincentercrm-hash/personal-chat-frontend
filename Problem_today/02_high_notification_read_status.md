# 02 - HIGH PRIORITY: ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Notification ‡πÅ‡∏•‡∏∞ Read Status

**‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: üî¥ HIGH PRIORITY**
**‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å: ‚≠ê‚≠ê ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á**

---

## üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤

### #24: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏≠‡πà‡∏≤‡∏ô ‡πÅ‡∏ï‡πà notification ‡∏´‡∏≤‡∏¢
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:**
- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏ï‡πà notification badge (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô) ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
- ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:**
1. **WebSocket event handling ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:**
   - Mark as read ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover, preview, ‡∏´‡∏£‡∏∑‡∏≠ component mount)

2. **Auto-mark-as-read trigger ‡∏ú‡∏¥‡∏î:**
   - Conversation list item render ‚Üí mark as read
   - Message preview load ‚Üí mark as read

3. **Unread count calculation ‡∏ú‡∏¥‡∏î:**
   - Backend ‡∏™‡πà‡∏á unread count = 0 ‡πÅ‡∏°‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô
   - Frontend ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì unread count ‡∏ú‡∏¥‡∏î

4. **Real-time sync issue:**
   - ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí sync ‡∏°‡∏≤ ‡πÅ‡∏ï‡πà user ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£ mark as read:**
   ```typescript
   // ‡∏ï‡πâ‡∏≠‡∏á mark as read ‡πÄ‡∏°‡∏∑‡πà‡∏≠:
   // - User ‡πÄ‡∏õ‡∏¥‡∏î conversation ‡∏à‡∏£‡∏¥‡∏á‡πÜ (navigation ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ)
   // - Message visible ‡πÉ‡∏ô viewport ‡∏Ç‡∏≠‡∏á chat window
   // - User active (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà background tab)
   ```

2. **‡πÄ‡∏û‡∏¥‡πà‡∏° logging:**
   - Log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ mark as read
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà

3. **Optimistic update ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:**
   - Mark as read ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ user action ‡∏à‡∏£‡∏¥‡∏á‡πÜ
   - Rollback ‡∏ñ‡πâ‡∏≤ API fail

4. **‡πÉ‡∏ä‡πâ Intersection Observer:**
   - Mark as read ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà user ‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ

**Backend ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
‚úÖ **‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:**
1. **API Endpoint: Mark as Read**
   - `POST /api/conversations/{id}/read`
   - ‡∏ï‡πâ‡∏≠‡∏á validate: user ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á conversation
   - Return updated unread count

2. **WebSocket Events:**
   - ‡∏™‡πà‡∏á `message.read` event ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡πà‡∏≤‡∏ô
   - Payload: `{ conversationId, userId, lastReadMessageId, readAt }`

3. **Unread Count API:**
   - `GET /api/conversations/unread-counts`
   - Return accurate unread count per conversation

---

### #25: ‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:**
- ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß" (read status) ‡πÅ‡∏ï‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô
- Read receipt (‚úì‚úì ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ú‡∏¥‡∏î

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:**
1. **Backend ‡∏™‡πà‡∏á read event ‡∏ú‡∏¥‡∏î‡πÄ‡∏ß‡∏•‡∏≤:**
   - ‡∏™‡πà‡∏á read event ‡∏ï‡∏≠‡∏ô deliver ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ

2. **Frontend mark as read ‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ:**
   - Mark as read ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà fetch messages ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•

3. **Read status sync ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:**
   - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ track `lastReadMessageId` ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. **Read Status State Management:**
   ```typescript
   interface ReadStatus {
     messageId: string;
     readBy: Array<{
       userId: string;
       readAt: Date;
     }>;
   }
   ```

2. **Read Receipt Logic:**
   - ‡πÅ‡∏™‡∏î‡∏á ‚úì (sent) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
   - ‡πÅ‡∏™‡∏î‡∏á ‚úì‚úì (delivered) ‡πÄ‡∏°‡∏∑‡πà‡∏≠ server ‡∏£‡∏±‡∏ö
   - ‡πÅ‡∏™‡∏î‡∏á ‚úì‚úì ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (read) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ

3. **Intersection Observer:**
   - Mark as read ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà visible ‡πÉ‡∏ô viewport ‡∏ô‡∏≤‡∏ô > 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
   - ‡∏™‡πà‡∏á read event ‡πÑ‡∏õ backend

**Backend ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
‚úÖ **‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:**
1. **Message Status Tracking:**
   ```json
   {
     "messageId": "msg_123",
     "status": "sent" | "delivered" | "read",
     "deliveredAt": "2024-01-01T10:00:00Z",
     "readAt": "2024-01-01T10:05:00Z",
     "readBy": [
       {
         "userId": "user_456",
         "readAt": "2024-01-01T10:05:00Z"
       }
     ]
   }
   ```

2. **API Endpoints:**
   - `POST /api/messages/{id}/mark-as-read`
   - Return: updated read status

3. **WebSocket Events:**
   - `message.delivered` - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
   - `message.read` - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ
   - ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ update read receipt

4. **For Group Chat:**
   - Track read status ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° user
   - Return array ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß

---

## üéØ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö)

### Phase 1: Investigation (1-2 ‡∏ä‡∏°.)
1. ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡πÉ‡∏ô mark-as-read logic
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö WebSocket events ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏≤ trigger ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤

### Phase 2: Frontend Fix (2-3 ‡∏ä‡∏°.)
1. ‡πÅ‡∏Å‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç mark as read
   - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ navigate ‡πÄ‡∏Ç‡πâ‡∏≤ conversation
   - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà visible
2. ‡πÄ‡∏û‡∏¥‡πà‡∏° Intersection Observer
3. Optimistic update ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### Phase 3: Backend Coordination (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏Å‡∏±‡∏ö Backend)
1. Verify WebSocket events
2. Test read status tracking
3. Test group chat read receipts

### Phase 4: Testing
1. Test ‡πÅ‡∏ä‡∏ó‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
2. Test ‡∏Å‡∏•‡∏∏‡πà‡∏° (multiple users)
3. Test multiple devices
4. Test background tab vs active tab

---

## üì¶ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ

**Frontend:**
- `src/components/Chat/MessageList.tsx` - Intersection Observer
- `src/services/websocket.ts` - Event handlers
- `src/stores/conversationStore.ts` - Mark as read logic
- `src/components/Chat/MessageItem.tsx` - Read receipt display

**Backend (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏° Backend):**
- WebSocket event handlers
- Read status tracking API
- Message delivery/read tracking

---

## ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£ Test

**‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö #24 (Notification):**
- [x] ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡πá‡∏ô badge (1)
- [x] Hover ‡∏ó‡∏µ‡πà conversation ‚Üí badge ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
- [x] Click ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏≠‡πà‡∏≤‡∏ô ‚Üí badge ‡∏´‡∏≤‡∏¢
- [x] ‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà ‚Üí badge ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
- [x] Test ‡πÉ‡∏ô background tab

**‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö #25 (Read Status):**
- [x] A ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí A ‡πÄ‡∏´‡πá‡∏ô ‚úì (sent)
- [x] B ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‚Üí A ‡πÄ‡∏´‡πá‡∏ô ‚úì‚úì (delivered)
- [x] B ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó ‚Üí A ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô ‚úì‚úì ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
- [x] B ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô ‚Üí A ‡πÄ‡∏´‡πá‡∏ô ‚úì‚úì ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (read)
- [x] Test ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Üí ‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô
- [x] Test ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Üí group chat ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏ô‡∏∂‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô bubble ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡∏¥